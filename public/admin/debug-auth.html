<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auth - Brooklyn Barbearia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        h2 {
            color: #569cd6;
            margin: 30px 0 15px;
            font-size: 1.3rem;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-line {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }
        .info-line:last-child { border-bottom: none; }
        .label {
            color: #ce9178;
            min-width: 200px;
            font-weight: bold;
        }
        .value {
            color: #b5cea8;
            word-break: break-all;
        }
        .status-ok { color: #4ec9b0; font-weight: bold; }
        .status-error { color: #f48771; font-weight: bold; }
        .status-warning { color: #dcdcaa; font-weight: bold; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            font-family: inherit;
        }
        button:hover { background: #1177bb; }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        pre {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .test-result.success {
            background: #1e3a2e;
            border-color: #4ec9b0;
        }
        .test-result.error {
            background: #3a1e1e;
            border-color: #f48771;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug de Autentica√ß√£o</h1>
        
        <div class="section">
            <h2>üåç Informa√ß√£o do Ambiente</h2>
            <div class="info-line">
                <span class="label">URL Atual:</span>
                <span class="value" id="currentUrl"></span>
            </div>
            <div class="info-line">
                <span class="label">Hostname:</span>
                <span class="value" id="hostname"></span>
            </div>
            <div class="info-line">
                <span class="label">Environment:</span>
                <span class="value" id="environment"></span>
            </div>
        </div>

        <div class="section">
            <h2>üîë Tokens no LocalStorage</h2>
            <div class="info-line">
                <span class="label">admin_token:</span>
                <span class="value" id="adminToken"></span>
            </div>
            <div class="info-line">
                <span class="label">adminToken (legacy):</span>
                <span class="value" id="adminTokenLegacy"></span>
            </div>
            <div class="info-line">
                <span class="label">admin_user:</span>
                <span class="value" id="adminUser"></span>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="clearTokens()">üóëÔ∏è Limpar Tokens</button>
                <button onclick="refreshInfo()">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Testes de API</h2>
            <button onclick="testPublicEndpoint()">‚úÖ Testar Endpoint P√∫blico</button>
            <button onclick="testProtectedEndpoint()">üîí Testar Endpoint Protegido</button>
            <button onclick="testLoginFlow()">üîê Simular Login</button>
            
            <div id="testResults"></div>
        </div>

        <div class="section">
            <h2>üìù Token JWT Decoded (se dispon√≠vel)</h2>
            <pre id="decodedToken">Nenhum token dispon√≠vel</pre>
        </div>

        <div class="section">
            <h2>üêû Solu√ß√µes Comuns</h2>
            <ul style="line-height: 1.8; padding-left: 20px;">
                <li><strong>401 Unauthorized:</strong> Fa√ßa logout e login novamente</li>
                <li><strong>Token expirado:</strong> Tokens t√™m validade de 24h</li>
                <li><strong>Preview branch:</strong> Environment vari√°veis podem n√£o estar configuradas</li>
                <li><strong>CORS:</strong> Certifique-se que est√° no dom√≠nio correto</li>
            </ul>
        </div>
    </div>

    <script>
        // Update environment info
        function refreshInfo() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('hostname').textContent = window.location.hostname;
            
            const hostname = window.location.hostname;
            let env = 'üü¢ Produ√ß√£o';
            if (hostname.includes('pages.dev')) {
                if (hostname.includes('fix-admin')) {
                    env = 'üü° Preview Branch (fix-admin-cleanup-and-fixes)';
                } else {
                    env = 'üü† Development (pages.dev)';
                }
            } else if (hostname === 'localhost') {
                env = 'üîµ Local';
            }
            document.getElementById('environment').innerHTML = env;

            // Token info
            const adminToken = localStorage.getItem('admin_token');
            const adminTokenLegacy = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('admin_user');

            document.getElementById('adminToken').innerHTML = adminToken 
                ? `<span class="status-ok">‚úì Presente</span> (${adminToken.length} chars)` 
                : '<span class="status-error">‚úó Ausente</span>';
            
            document.getElementById('adminTokenLegacy').innerHTML = adminTokenLegacy 
                ? `<span class="status-ok">‚úì Presente</span> (${adminTokenLegacy.length} chars)` 
                : '<span class="status-error">‚úó Ausente</span>';
            
            document.getElementById('adminUser').innerHTML = adminUser 
                ? `<span class="status-ok">‚úì Presente</span>` 
                : '<span class="status-error">‚úó Ausente</span>';

            // Decode JWT if present
            if (adminToken) {
                try {
                    const parts = adminToken.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        document.getElementById('decodedToken').textContent = JSON.stringify(payload, null, 2);
                        
                        // Check expiration
                        if (payload.exp) {
                            const expDate = new Date(payload.exp * 1000);
                            const now = new Date();
                            const isExpired = expDate < now;
                            
                            const expInfo = document.createElement('div');
                            expInfo.style.marginTop = '10px';
                            expInfo.innerHTML = `
                                <strong>Expira em:</strong> ${expDate.toLocaleString('pt-PT')}<br>
                                <strong>Status:</strong> ${isExpired 
                                    ? '<span class="status-error">EXPIRADO</span>' 
                                    : '<span class="status-ok">V√°lido</span>'}
                            `;
                            document.getElementById('decodedToken').appendChild(expInfo);
                        }
                    }
                } catch (e) {
                    document.getElementById('decodedToken').textContent = 'Erro ao decodificar: ' + e.message;
                }
            }
        }

        function clearTokens() {
            if (confirm('Tem certeza que deseja limpar todos os tokens?')) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('adminToken');
                localStorage.removeItem('admin_user');
                refreshInfo();
                addTestResult('Tokens limpos com sucesso', 'success');
            }
        }

        function addTestResult(message, type = 'success', details = null) {
            const resultsDiv = document.getElementById('testResults');
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>${message}</strong>`;
            if (details) {
                const pre = document.createElement('pre');
                pre.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
                result.appendChild(pre);
            }
            resultsDiv.insertBefore(result, resultsDiv.firstChild);
        }

        async function testPublicEndpoint() {
            addTestResult('üîç Testando endpoint p√∫blico...', 'success');
            try {
                const response = await fetch('/api/api_barbeiros');
                const data = await response.json();
                addTestResult(
                    `‚úÖ Endpoint p√∫blico funcionando (Status ${response.status})`,
                    'success',
                    data
                );
            } catch (error) {
                addTestResult(
                    '‚ùå Erro no endpoint p√∫blico',
                    'error',
                    error.message
                );
            }
        }

        async function testProtectedEndpoint() {
            addTestResult('üîç Testando endpoint protegido...', 'success');
            const token = localStorage.getItem('admin_token') || localStorage.getItem('adminToken');
            
            if (!token) {
                addTestResult('‚ùå Sem token! Fa√ßa login primeiro.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/api_admin_clientes', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.status === 401) {
                    addTestResult(
                        '‚ùå 401 Unauthorized - Token inv√°lido ou expirado',
                        'error',
                        data
                    );
                } else if (response.ok) {
                    addTestResult(
                        `‚úÖ Endpoint protegido funcionando (Status ${response.status})`,
                        'success',
                        `Clientes retornados: ${data.clientes?.length || 0}`
                    );
                } else {
                    addTestResult(
                        `‚ö†Ô∏è Resposta inesperada (Status ${response.status})`,
                        'error',
                        data
                    );
                }
            } catch (error) {
                addTestResult(
                    '‚ùå Erro no endpoint protegido',
                    'error',
                    error.message
                );
            }
        }

        async function testLoginFlow() {
            addTestResult('üö® Teste de login requer credenciais reais!', 'error', 'Use a p√°gina de login normal.');
        }

        // Initialize on load
        refreshInfo();
    </script>
</body>
</html>